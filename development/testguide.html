
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Testing Guidelines &#8212; scikit-beam 0.0.12.post8+g7aaf6ce documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.12.post8+g7aaf6ce',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Writing Command-Line Scripts" href="scripts.html" />
    <link rel="prev" title="Scikit-beam Docstring Rules" href="docrules.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="testing-guidelines">
<span id="id1"></span><h1>Testing Guidelines<a class="headerlink" href="#testing-guidelines" title="Permalink to this headline">¶</a></h1>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This page is not fully adapted from astropy</p>
</div>
<p>This section describes the testing framework and format standards for tests in
Scikit-beam core packages (this also serves as recommendations for affiliated
packages).</p>
<div class="section" id="testing-framework">
<h2>Testing Framework<a class="headerlink" href="#testing-framework" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">We still need to port from nose</p>
</div>
<p>The testing framework used by Scikit-beam is the <a class="reference external" href="http://pytest.org/latest/">py.test</a> framework.</p>
</div>
<div class="section" id="running-tests">
<span id="id3"></span><h2>Running Tests<a class="headerlink" href="#running-tests" title="Permalink to this headline">¶</a></h2>
<p>There are currently three different ways to invoke Scikit-beam tests. Each
method invokes <a class="reference external" href="http://pytest.org/latest/">py.test</a> to run the tests but offers different options when
calling.</p>
<p>In addition to running the Scikit-beam tests, these methods can also be called
so that they check Python source code for <a class="reference external" href="http://www.python.org/dev/peps/pep-0008/">PEP8 compliance</a>. All of the PEP8 testing
options require the <a class="reference external" href="http://pypi.python.org/pypi/pytest-pep8">pytest-pep8 plugin</a>, which must be installed
separately.</p>
<div class="section" id="run-tests-py">
<h3>run_tests.py<a class="headerlink" href="#run-tests-py" title="Permalink to this headline">¶</a></h3>
<p>There is a script at the top level of skbeam</p>
</div>
<div class="section" id="id4">
<h3>py.test<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This might not work, we still need to finish porting from nose.</p>
</div>
<p>An alternative way to run tests from the command line is to switch to the source
code directory of scikit-beam and simply type:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">py</span><span class="o">.</span><span class="n">test</span>
</pre></div>
</div>
<p><a class="reference external" href="http://pytest.org/latest/">py.test</a> will look for files that <a class="reference external" href="http://pytest.org/latest/goodpractises.html#conventions-for-python-test-discovery">look like tests</a>
in the current directory and all recursive directories then run all the code that
<a class="reference external" href="http://pytest.org/latest/goodpractises.html#conventions-for-python-test-discovery">looks like tests</a>
within those files.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">To test any compiled C/Cython extensions, you must run <code class="docutils literal"><span class="pre">python</span> <span class="pre">setup.py</span>
<span class="pre">develop</span></code> prior to running the py.test command-line script.  Otherwise,
any tests that make use of these extensions will not succeed.</p>
</div>
<p>You may specify a specific test file or directory at the command line:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">py</span><span class="o">.</span><span class="n">test</span> <span class="n">test_file</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>To run a specific test within a file use the <code class="docutils literal"><span class="pre">-k</span></code> option:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">py</span><span class="o">.</span><span class="n">test</span> <span class="n">test_file</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">k</span> <span class="s2">&quot;test_function&quot;</span>
</pre></div>
</div>
<p>You may also use the <code class="docutils literal"><span class="pre">-k</span></code> option to not run tests py putting a <code class="docutils literal"><span class="pre">-</span></code> in front
of the matching string:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">py</span><span class="o">.</span><span class="n">test</span> <span class="n">test_file</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">k</span> <span class="s2">&quot;-test_function&quot;</span>
</pre></div>
</div>
<p>py.test has a number of <a class="reference external" href="http://pytest.org/latest/usage.html">command line usage options.</a></p>
<p>Turn on PEP8 testing by adding the <code class="docutils literal"><span class="pre">--pep8</span></code> flag to the <a class="reference external" href="http://pytest.org/latest/">py.test</a> call. By
default regular tests will also be run but these can be turned off by adding
<code class="docutils literal"><span class="pre">-k</span> <span class="pre">pep8</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">py</span><span class="o">.</span><span class="n">test</span> <span class="n">some_dir</span> <span class="o">--</span><span class="n">pep8</span> <span class="o">-</span><span class="n">k</span> <span class="n">pep8</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This method of running the tests uses the locally-installed version of
<a class="reference external" href="http://pytest.org/latest/">py.test</a> rather than the bundled one, and hence will fail if the local
version it is not up-to-date enough (<a class="reference external" href="http://pytest.org/latest/">py.test</a> 2.2 as of this writing).</p>
</div>
</div>
<div class="section" id="scikit-beam-test">
<span id="id5"></span><h3>scikit-beam.test()<a class="headerlink" href="#scikit-beam-test" title="Permalink to this headline">¶</a></h3>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This is not implemented yet</p>
</div>
<p>Scikit-beam includes a standalone version of py.test that allows to tests
to be run even if py.test is not installed. Tests can be run from within
Scikit-beam with:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scikit</span><span class="o">-</span><span class="n">beam</span>
<span class="n">scikit</span><span class="o">-</span><span class="n">beam</span><span class="o">.</span><span class="n">test</span><span class="p">()</span>
</pre></div>
</div>
<p>This will run all the default tests for Scikit-beam.</p>
<p>Tests for a specific package can be run by specifying the package in the call
to the <code class="docutils literal"><span class="pre">test()</span></code> function:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">scikit</span><span class="o">-</span><span class="n">beam</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="s1">&#39;io.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This method works only with package names that can be mapped to Scikit-beam
directories. As an alternative you can test a specific directory or file
with the <code class="docutils literal"><span class="pre">test_path</span></code> option:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">scikit</span><span class="o">-</span><span class="n">beam</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">test_path</span><span class="o">=</span><span class="s1">&#39;wcs/tests/test_wcs.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">test_path</span></code> must be specified either relative to the working directory
or absolutely.</p>
<p>By default <a class="reference internal" href="#scikit-beam-test">scikit-beam.test()</a> will skip tests which retrieve data from the
internet. To turn these tests on use the <code class="docutils literal"><span class="pre">remote_data</span></code> flag:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">scikit</span><span class="o">-</span><span class="n">beam</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="s1">&#39;io.fits&#39;</span><span class="p">,</span> <span class="n">remote_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>In addition, the <code class="docutils literal"><span class="pre">test</span></code> function supports any of the options that can be
passed to <a class="reference external" href="http://pytest.org/latest/builtin.html#pytest.main">pytest.main()</a>,
and convenience options <code class="docutils literal"><span class="pre">verbose=</span></code> and <code class="docutils literal"><span class="pre">pastebin=</span></code>.</p>
<p>Enable PEP8 compliance testing with <code class="docutils literal"><span class="pre">pep8=True</span></code> in the call to
<code class="docutils literal"><span class="pre">scikit-beam.test</span></code>. This will enable PEP8 checking and disable regular tests.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This method of running the tests defaults to the version of
<a class="reference external" href="http://pytest.org/latest/">py.test</a> that is bundled with Scikit-beam. To use the locally-installed
version, you should set the <code class="docutils literal"><span class="pre">ASTROPY_USE_SYSTEM_PYTEST</span></code> environment
variable  or the <a class="reference external" href="http://pytest.org/latest/">py.test</a> method described
above.</p>
</div>
</div>
<div class="section" id="tox">
<h3>Tox<a class="headerlink" href="#tox" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://tox.readthedocs.org">Tox</a> is a sort of meta-test runner for Python.
It installs a project into one or more virtualenvs (usually one for each Python
version supported), build and installs the project into each virtualenv, and
runs the projects tests (or any other build processes one might want to test).
This is a good way to run the tests against multiple installed Python versions
locally without pushing to a continuous integration system.</p>
<p>Tox works by detecting the presence of a file called <code class="docutils literal"><span class="pre">tox.ini</span></code> in the root of
a Python project and using that to configure the desired virtualenvs and start
the tests.  So to run the Scikit-beam tests on multiple Python versions using tox,
simply install Tox:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ pip install tox
</pre></div>
</div>
<p>and then from the root of an Scikit-beam repository clone run:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tox
</pre></div>
</div>
<p>The Scikit-beam tox configuration currently tests against Python versions 2.6, 2.7,
3.2, and 3.3.  Tox will automatically skip any Python versions you do not have
installed, but best results are achieved if you first install all supported
Python versions and make sure they are on your <code class="docutils literal"><span class="pre">$PATH</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Tox creates its virtualenvs in the root of your project under a <code class="docutils literal"><span class="pre">.tox</span></code>
directory (which is automatically ignored by <code class="docutils literal"><span class="pre">.gitignore</span></code>).  It’s worth
making note of this, however, as it is common practice to sometimes clean
up a git repository and delete any untracked files by running the <code class="docutils literal"><span class="pre">git</span>
<span class="pre">clean</span> <span class="pre">-dfx</span></code> command.  As it can take a long time to rebuild the tox
virtualenvs you may want to exclude the <code class="docutils literal"><span class="pre">.tox</span></code> directory from any
cleanup.  This can be achieved by running <code class="docutils literal"><span class="pre">git</span> <span class="pre">clean</span> <span class="pre">-dfx</span> <span class="pre">-e</span> <span class="pre">.tox</span></code>,
though it is probably worth defining a <a class="reference external" href="https://git.wiki.kernel.org/index.php/Aliases">git alias</a> to do this.</p>
</div>
</div>
<div class="section" id="test-running-options">
<h3>Test-running options<a class="headerlink" href="#test-running-options" title="Permalink to this headline">¶</a></h3>
<div class="section" id="running-parts-of-the-test-suite">
<h4>Running parts of the test suite<a class="headerlink" href="#running-parts-of-the-test-suite" title="Permalink to this headline">¶</a></h4>
<p>It is possible to run only the tests for a particular subpackage.  For
example, to run only the <code class="docutils literal"><span class="pre">wcs</span></code> tests from the commandline:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">test</span> <span class="o">-</span><span class="n">P</span> <span class="n">wcs</span>
</pre></div>
</div>
<p>Or from Python:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">scikit</span><span class="o">-</span><span class="n">beam</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">scikit</span><span class="o">-</span><span class="n">beam</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">package</span><span class="o">=</span><span class="s2">&quot;wcs&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>You can also specify a single file to test from the commandline:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">test</span> <span class="o">-</span><span class="n">t</span> <span class="n">scikit</span><span class="o">-</span><span class="n">beam</span><span class="o">/</span><span class="n">wcs</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">test_wcs</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>When the <code class="docutils literal"><span class="pre">-t</span></code> option is given a relative path, it is relative to the
installed root of scikit-beam.  When <code class="docutils literal"><span class="pre">-t</span></code> is given a relative path to a
documentation <code class="docutils literal"><span class="pre">.rst</span></code> file to test, it is relative to the root of the
documentation, i.e. the <code class="docutils literal"><span class="pre">docs</span></code> directory in the source tree.  For
example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">test</span> <span class="o">-</span><span class="n">t</span> <span class="n">units</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">rst</span>
</pre></div>
</div>
</div>
<div class="section" id="testing-for-open-files">
<h4>Testing for open files<a class="headerlink" href="#testing-for-open-files" title="Permalink to this headline">¶</a></h4>
<p>Scikit-beam can test whether any of the unit tests inadvertently leave any
files open.  Since this greatly slows down the time it takes to run
the tests, it is turned off by default.</p>
<p>To use it from the commandline, do:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">test</span> <span class="o">--</span><span class="nb">open</span><span class="o">-</span><span class="n">files</span>
</pre></div>
</div>
<p>To use it from Python, do:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">scikit</span><span class="o">-</span><span class="n">beam</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">scikit</span><span class="o">-</span><span class="n">beam</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">open_files</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="test-coverage-reports">
<h4>Test coverage reports<a class="headerlink" href="#test-coverage-reports" title="Permalink to this headline">¶</a></h4>
<p>Scikit-beam can use <a class="reference external" href="http://nedbatchelder.com/code/coverage/">coverage.py</a> to
generate test coverage reports.  To generate a test coverage report, use:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">test</span> <span class="o">--</span><span class="n">coverage</span>
</pre></div>
</div>
<p>There is a <a class="reference external" href="http://nedbatchelder.com/code/coverage/config.html">coveragerc</a> file that
defines files to omit as well as lines to exclude.  It is installed
along with scikit-beam so that the <code class="docutils literal"><span class="pre">scikit-beam</span></code> testing framework can use
it.  In the source tree, it is at <code class="docutils literal"><span class="pre">scikit-beam/tests/coveragerc</span></code>.</p>
</div>
<div class="section" id="running-tests-in-parallel">
<h4>Running tests in parallel<a class="headerlink" href="#running-tests-in-parallel" title="Permalink to this headline">¶</a></h4>
<p>It is possible to speed up scikit-beam’s tests using the <a class="reference external" href="https://pypi.python.org/pypi/pytest-xdist">pytest-xdist</a> plugin.  This plugin can be
installed using <a class="reference external" href="http://www.pip-installer.org/en/latest/">pip</a>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">pytest</span><span class="o">-</span><span class="n">xdist</span>
</pre></div>
</div>
<p>Once installed, tests can be run in parallel using the <code class="docutils literal"><span class="pre">'--parallel'</span></code>
commandline option.  For example, to use 4 processes:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">test</span> <span class="o">--</span><span class="n">parallel</span><span class="o">=</span><span class="mi">4</span>
</pre></div>
</div>
<p>Pass a negative number to <code class="docutils literal"><span class="pre">'--parallel'</span></code> to create the same number of
processes as cores on your machine.</p>
<p>Similarly, this feature can be invoked from Python:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">scikit</span><span class="o">-</span><span class="n">beam</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">scikit</span><span class="o">-</span><span class="n">beam</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">parallel</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="writing-tests">
<h2>Writing tests<a class="headerlink" href="#writing-tests" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">py.test</span></code> has the following test discovery rules:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">test_*.py</span></code> or <code class="docutils literal"><span class="pre">*_test.py</span></code> files</li>
<li><code class="docutils literal"><span class="pre">Test</span></code> prefixed classes (without an <code class="docutils literal"><span class="pre">__init__</span></code> method)</li>
<li><code class="docutils literal"><span class="pre">test_</span></code> prefixed functions and methods</li>
</ul>
</div></blockquote>
<p>Consult the <a class="reference external" href="http://pytest.org/latest/goodpractises.html#conventions-for-python-test-discovery">test discovery rules</a>
for detailed information on how to name files and tests so that they are
automatically discovered by <a class="reference external" href="http://pytest.org/latest/">py.test</a>.</p>
<div class="section" id="simple-example">
<h3>Simple example<a class="headerlink" href="#simple-example" title="Permalink to this headline">¶</a></h3>
<p>The following example shows a simple function and a test to test this
function:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add one to the argument.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">test_answer</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Check the return value of func() for an example argument.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">func</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span>
</pre></div>
</div>
<p>If we place this in a <code class="docutils literal"><span class="pre">test.py</span></code> file and then run:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">py</span><span class="o">.</span><span class="n">test</span> <span class="n">test</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>The result is:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">=============================</span> <span class="n">test</span> <span class="n">session</span> <span class="n">starts</span> <span class="o">==============================</span>
<span class="n">python</span><span class="p">:</span> <span class="n">platform</span> <span class="n">darwin</span> <span class="o">--</span> <span class="n">Python</span> <span class="mf">2.7</span><span class="o">.</span><span class="mi">2</span> <span class="o">--</span> <span class="n">pytest</span><span class="o">-</span><span class="mf">1.1</span><span class="o">.</span><span class="mi">1</span>
<span class="n">test</span> <span class="nb">object</span> <span class="mi">1</span><span class="p">:</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">tom</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">test</span><span class="o">.</span><span class="n">py</span>

<span class="n">test</span><span class="o">.</span><span class="n">py</span> <span class="n">F</span>

<span class="o">===================================</span> <span class="n">FAILURES</span> <span class="o">===================================</span>
<span class="n">_________________________________</span> <span class="n">test_answer</span> <span class="n">__________________________________</span>

    <span class="k">def</span> <span class="nf">test_answer</span><span class="p">():</span>
<span class="o">&gt;</span>       <span class="k">assert</span> <span class="n">func</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span>
<span class="n">E</span>       <span class="k">assert</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">5</span>
<span class="n">E</span>        <span class="o">+</span>  <span class="n">where</span> <span class="mi">4</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="n">test</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span> <span class="ne">AssertionError</span>
<span class="o">===========================</span> <span class="mi">1</span> <span class="n">failed</span> <span class="ow">in</span> <span class="mf">0.07</span> <span class="n">seconds</span> <span class="o">===========================</span>
</pre></div>
</div>
</div>
<div class="section" id="where-to-put-tests">
<h3>Where to put tests<a class="headerlink" href="#where-to-put-tests" title="Permalink to this headline">¶</a></h3>
<div class="section" id="package-specific-tests">
<h4>Package-specific tests<a class="headerlink" href="#package-specific-tests" title="Permalink to this headline">¶</a></h4>
<p>Each package should include a suite of unit tests, covering as many of
the public methods/functions as possible. These tests should be
included inside each sub-package, e.g:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">scikit</span><span class="o">-</span><span class="n">beam</span><span class="o">/</span><span class="n">io</span><span class="o">/</span><span class="n">fits</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">tests</span></code> directories should contain an <code class="docutils literal"><span class="pre">__init__.py</span></code> file so that
the tests can be imported and so that they can use relative imports.</p>
</div>
<div class="section" id="interoperability-tests">
<h4>Interoperability tests<a class="headerlink" href="#interoperability-tests" title="Permalink to this headline">¶</a></h4>
<p>Tests involving two or more sub-packages should be included in:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">scikit</span><span class="o">-</span><span class="n">beam</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="regression-tests">
<h3>Regression tests<a class="headerlink" href="#regression-tests" title="Permalink to this headline">¶</a></h3>
<p>Any time a bug is fixed, and wherever possible, one or more regression tests
should be added to ensure that the bug is not introduced in future. Regression
tests should include the ticket URL where the bug was reported.</p>
</div>
<div class="section" id="working-with-data-files">
<h3>Working with data files<a class="headerlink" href="#working-with-data-files" title="Permalink to this headline">¶</a></h3>
<p>Tests that need to make use of a data file should use the
<code class="xref py py-func docutils literal"><span class="pre">get_pkg_data_fileobj()</span></code> or
<code class="xref py py-func docutils literal"><span class="pre">get_pkg_data_filename()</span></code> functions.  These functions
search locally first, and then on the scikit-beam data server or an arbitrary
URL, and return a file-like object or a local filename, respectively.  They
automatically cache the data locally if remote data is obtained, and from
then on the local copy will be used transparently.  See the next section for
note specific to dealing with the cache in tests.</p>
<p>They also support the use of an MD5 hash to get a specific version of a data
file.  This hash can be obtained prior to submitting a file to the scikit-beam
data server by using the <code class="xref py py-func docutils literal"><span class="pre">compute_hash()</span></code> function on a
local copy of the file.</p>
<p>Tests that may retrieve remote data should be marked with the
<code class="docutils literal"><span class="pre">&#64;remote_data</span></code> decorator, or, if a doctest, flagged with the
<code class="docutils literal"><span class="pre">REMOTE_DATA</span></code> flag.  Tests marked in this way will be skipped by default
by <code class="docutils literal"><span class="pre">scikit-beam.test()</span></code> to prevent test runs from taking too long. These
tests can be run by <code class="docutils literal"><span class="pre">scikit-beam.test()</span></code> by adding the
<code class="docutils literal"><span class="pre">remote_data=True</span></code> flag.  Turn on the remote data tests at the
command line with <code class="docutils literal"><span class="pre">py.test</span> <span class="pre">--remote-data</span></code>.</p>
<div class="section" id="examples">
<h4>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h4>
<div class="highlight-none"><div class="highlight"><pre><span></span>from ...config import get_data_filename
from ...tests.helper import remote_data

def test_1():
    &quot;&quot;&quot;Test version using a local file.&quot;&quot;&quot;
    #if filename.fits is a local file in the source distribution
    datafile = get_data_filename(&#39;filename.fits&#39;)
    # do the test

@remote_data
def test_2():
    &quot;&quot;&quot;Test version using a remote file.&quot;&quot;&quot;
    #this is the hash for a particular version of a file stored on the
    #scikit-beam data server.
    datafile = get_data_filename(&#39;hash/94935ac31d585f68041c08f87d1a19d4&#39;)
    # do the test

def doctest_example():
    &quot;&quot;&quot;
    &gt;&gt;&gt; datafile = get_data_filename(&#39;hash/94935&#39;)  # doctest: +REMOTE_DATA
    &quot;&quot;&quot;
    pass
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">get_remote_test_data</span></code> will place the files in a temporary directory
indicated by the <code class="docutils literal"><span class="pre">tempfile</span></code> module, so that the test files will eventually
get removed by the system. In the long term, once test data files become too
large, we will need to design a mechanism for removing test data immediately.</p>
</div>
<div class="section" id="tests-that-use-the-file-cache">
<h4>Tests that use the file cache<a class="headerlink" href="#tests-that-use-the-file-cache" title="Permalink to this headline">¶</a></h4>
<p>By default, the Scikit-beam test runner sets up a clean file cache in a temporary
directory that is used only for that test run and then destroyed.  This is to
ensure consistency between test runs, as well as to not clutter users’ caches
(i.e. the cache directory returned by <code class="xref py py-func docutils literal"><span class="pre">get_cache_dir()</span></code>) with
test files.</p>
<p>However, some test authors (especially for affiliated packages) may find it
desirable to cache files downloaded during a test run in a more permanent
location (e.g. for large data sets).  To this end the
<code class="xref py py-func docutils literal"><span class="pre">set_temp_cache()</span></code> helper may be used.  It can be used either as
a context manager within a test to temporarily set the cache to a custom
location, or as a <em>decorator</em> that takes effect for an entire test function
(not including setup or teardown, which would have to be decorated separately).</p>
<p>Furthermore, it is possible to set an option <code class="docutils literal"><span class="pre">cache_dir</span></code> in the py.test
config file which sets the cache location for the entire test run.  A
<code class="docutils literal"><span class="pre">--cache-dir</span></code> command-line option is also supported (which overrides all
other settings).  Currently it is not directly supported by the
<code class="docutils literal"><span class="pre">./setup.py</span> <span class="pre">test</span></code> command, so it is necessary to use it with the <code class="docutils literal"><span class="pre">-a</span></code>
argument like:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ ./setup.py test -a &quot;--cache-dir=/path/to/custom/cache/dir&quot;
</pre></div>
</div>
</div>
</div>
<div class="section" id="tests-that-create-files">
<h3>Tests that create files<a class="headerlink" href="#tests-that-create-files" title="Permalink to this headline">¶</a></h3>
<p>Tests may often be run from directories where users do not have write
permissions so tests which create files should always do so in
temporary directories. This can be done with the <a class="reference external" href="http://pytest.org/latest/tmpdir.html">py.test tmpdir
function argument</a> or with
Python’s built-in <a class="reference external" href="http://docs.python.org/library/tempfile.html#module-tempfile">tempfile module</a>.</p>
</div>
<div class="section" id="setting-up-tearing-down-tests">
<h3>Setting up/Tearing down tests<a class="headerlink" href="#setting-up-tearing-down-tests" title="Permalink to this headline">¶</a></h3>
<p>In some cases, it can be useful to run a series of tests requiring something
to be set up first. There are four ways to do this:</p>
<div class="section" id="module-level-setup-teardown">
<h4>Module-level setup/teardown<a class="headerlink" href="#module-level-setup-teardown" title="Permalink to this headline">¶</a></h4>
<p>If the <code class="docutils literal"><span class="pre">setup_module</span></code> and <code class="docutils literal"><span class="pre">teardown_module</span></code> functions are specified in a
file, they are called before and after all the tests in the file respectively.
These functions take one argument, which is the module itself, which makes it
very easy to set module-wide variables:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">setup_module</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initialize the value of NUM.&quot;&quot;&quot;</span>
    <span class="n">module</span><span class="o">.</span><span class="n">NUM</span> <span class="o">=</span> <span class="mi">11</span>

<span class="k">def</span> <span class="nf">add_num</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add pre-defined NUM to the argument.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">NUM</span>

<span class="k">def</span> <span class="nf">test_42</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Ensure that add_num() adds the correct NUM to its argument.&quot;&quot;&quot;</span>
    <span class="n">added</span> <span class="o">=</span> <span class="n">add_num</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">added</span> <span class="o">==</span> <span class="mi">53</span>
</pre></div>
</div>
<p>We can use this for example to download a remote test data file and have all
the functions in the file access it:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">setup_module</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Store a copy of the remote test file.&quot;&quot;&quot;</span>
    <span class="n">module</span><span class="o">.</span><span class="n">DATAFILE</span> <span class="o">=</span> <span class="n">get_remote_test_data</span><span class="p">(</span><span class="s1">&#39;94935ac31d585f68041c08f87d1a19d4&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Perform test using cached remote input file.&quot;&quot;&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">DATAFILE</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="c1"># do the test</span>

<span class="k">def</span> <span class="nf">teardown_module</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Clean up remote test file copy.&quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">DATAFILE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="class-level-setup-teardown">
<h4>Class-level setup/teardown<a class="headerlink" href="#class-level-setup-teardown" title="Permalink to this headline">¶</a></h4>
<p>Tests can be organized into classes that have their own setup/teardown
functions. In the following</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_nums</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add two numbers.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="k">class</span> <span class="nc">TestAdd42</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test for add_nums with y=42.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">setup_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NUM</span> <span class="o">=</span> <span class="mi">42</span>

    <span class="k">def</span> <span class="nf">test_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test behaviour for a specific input value.&quot;&quot;&quot;</span>
        <span class="n">added</span> <span class="o">=</span> <span class="n">add_nums</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUM</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">added</span> <span class="o">==</span> <span class="mi">53</span>

    <span class="k">def</span> <span class="nf">test_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test behaviour for another input value.&quot;&quot;&quot;</span>
        <span class="n">added</span> <span class="o">=</span> <span class="n">add_nums</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUM</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">added</span> <span class="o">==</span> <span class="mi">55</span>

    <span class="k">def</span> <span class="nf">teardown_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
<p>In the above example, the <code class="docutils literal"><span class="pre">setup_class</span></code> method is called first, then all the
tests in the class, and finally the <code class="docutils literal"><span class="pre">teardown_class</span></code> is called.</p>
</div>
<div class="section" id="method-level-setup-teardown">
<h4>Method-level setup/teardown<a class="headerlink" href="#method-level-setup-teardown" title="Permalink to this headline">¶</a></h4>
<p>There are cases where one might want setup and teardown methods to be run
before and after <em>each</em> test. For this, use the <code class="docutils literal"><span class="pre">setup_method</span></code> and
<code class="docutils literal"><span class="pre">teardown_method</span></code> methods:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_nums</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add two numbers.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="k">class</span> <span class="nc">TestAdd42</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test for add_nums with y=42.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">setup_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NUM</span> <span class="o">=</span> <span class="mi">42</span>

    <span class="k">def</span> <span class="nf">test_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test behaviour for a specific input value.&quot;&quot;&quot;</span>
        <span class="n">added</span> <span class="o">=</span> <span class="n">add_nums</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUM</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">added</span> <span class="o">==</span> <span class="mi">53</span>

    <span class="k">def</span> <span class="nf">test_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test behaviour for another input value.&quot;&quot;&quot;</span>
        <span class="n">added</span> <span class="o">=</span> <span class="n">add_nums</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUM</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">added</span> <span class="o">==</span> <span class="mi">55</span>

    <span class="k">def</span> <span class="nf">teardown_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="section" id="function-level-setup-teardown">
<h4>Function-level setup/teardown<a class="headerlink" href="#function-level-setup-teardown" title="Permalink to this headline">¶</a></h4>
<p>Finally, one can use <code class="docutils literal"><span class="pre">setup_function</span></code> and <code class="docutils literal"><span class="pre">teardown_function</span></code> to define a
setup/teardown mechanism to be run before and after each function in a module.
These take one argument, which is the function being tested:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">setup_function</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">test_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;First test.&quot;&quot;&quot;</span>
    <span class="c1"># do test</span>

<span class="k">def</span> <span class="nf">test_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Second test.&quot;&quot;&quot;</span>
    <span class="c1"># do test</span>

<span class="k">def</span> <span class="nf">teardown_method</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="parametrizing-tests">
<h3>Parametrizing tests<a class="headerlink" href="#parametrizing-tests" title="Permalink to this headline">¶</a></h3>
<p>If you want to run a test several times for slightly different values, then
it can be advantageous to use the <code class="docutils literal"><span class="pre">py.test</span></code> option to parametrize tests.
For example, instead of writing:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test1</span><span class="p">():</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span>

<span class="k">def</span> <span class="nf">test2</span><span class="p">():</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span>

<span class="k">def</span> <span class="nf">test3</span><span class="p">():</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span>
</pre></div>
</div>
<p>You can use the <code class="docutils literal"><span class="pre">parametrize</span></code> decorator to loop over the different
inputs:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">((</span><span class="s1">&#39;letter&#39;</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">letter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check that the input is a string.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">letter</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span>
</pre></div>
</div>
</div>
<div class="section" id="tests-requiring-optional-dependencies">
<h3>Tests requiring optional dependencies<a class="headerlink" href="#tests-requiring-optional-dependencies" title="Permalink to this headline">¶</a></h3>
<p>For tests that test functions or methods that require optional
dependencies (e.g. Scipy), pytest should be instructed to skip the
test if the dependencies are not present. The following example shows
how this should be done:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">scipy</span>
    <span class="n">HAS_SCIPY</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">HAS_SCIPY</span> <span class="o">=</span> <span class="kc">False</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">skipif</span><span class="p">(</span><span class="s1">&#39;not HAS_SCIPY&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_that_uses_scipy</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>In this way, the test is run if Scipy is present, and skipped if
not. No tests should fail simply because an optional dependency is not
present.</p>
</div>
<div class="section" id="using-py-test-helper-functions">
<h3>Using py.test helper functions<a class="headerlink" href="#using-py-test-helper-functions" title="Permalink to this headline">¶</a></h3>
<p>If your tests need to use <a class="reference external" href="http://pytest.org/latest/builtin.html#pytest-helpers">py.test helper functions</a>, such as
<code class="docutils literal"><span class="pre">pytest.raises</span></code>, import <code class="docutils literal"><span class="pre">pytest</span></code> into your test module like so:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">...tests.helper</span> <span class="k">import</span> <span class="n">pytest</span>
</pre></div>
</div>
<p>You may need to adjust the relative import to work for the depth of
your module.  <code class="docutils literal"><span class="pre">tests.helper</span></code> imports <code class="docutils literal"><span class="pre">pytest</span></code> either from the
user’s system or <code class="docutils literal"><span class="pre">extern.pytest</span></code> if the user does not have py.test
installed. This is so that users need not install py.test to run
Scikit-beam’s tests.</p>
</div>
<div class="section" id="testing-warnings">
<h3>Testing warnings<a class="headerlink" href="#testing-warnings" title="Permalink to this headline">¶</a></h3>
<p>In order to test that warnings are triggered as expected in certain
situations, you can use the <code class="xref py py-func docutils literal"><span class="pre">scikit-beam.tests.helper.catch_warnings()</span></code>
context manager.  Unlike the <a class="reference external" href="https://docs.python.org/3.5/library/warnings.html#warnings.catch_warnings" title="(in Python v3.5)"><code class="xref py py-obj docutils literal"><span class="pre">warnings.catch_warnings</span></code></a> context manager
in the standard library, this one will reset all warning state before
hand so one is assured to get the warnings reported, regardless of
what errors may have been emitted by other tests previously.  Here is
a real-world example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scikit</span><span class="o">-</span><span class="n">beam</span><span class="o">.</span><span class="n">tests</span><span class="o">.</span><span class="n">helper</span> <span class="kn">import</span> <span class="nn">catch_warnings</span>

<span class="k">with</span> <span class="n">catch_warnings</span><span class="p">(</span><span class="n">MergeConflictWarning</span><span class="p">)</span> <span class="k">as</span> <span class="n">warning_lines</span><span class="p">:</span>
    <span class="c1"># Test code which triggers a MergeConflictWarning</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t4</span><span class="p">],</span> <span class="n">join_type</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">warning_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">category</span> <span class="o">==</span> <span class="n">metadata</span><span class="o">.</span><span class="n">MergeConflictWarning</span>
    <span class="k">assert</span> <span class="p">(</span><span class="s2">&quot;In merged column &#39;a&#39; the &#39;units&#39; attribute does not match (cm != m)&quot;</span>
            <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">warning_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="p">))</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Within <a class="reference external" href="http://pytest.org/latest/">py.test</a> there is also the option of using the <code class="docutils literal"><span class="pre">recwarn</span></code>
function argument to test that warnings are triggered.  This method has
been found to be problematic in at least one case (<a class="reference external" href="https://github.com/scikit-beam/scikit-beam/pull/1174#issuecomment-20249309">pull request 1174</a>)
so the <code class="xref py py-func docutils literal"><span class="pre">scikit-beam.tests.helper.catch_warnings()</span></code> context manager is
preferred.</p>
</div>
</div>
<div class="section" id="testing-configuration-parameters">
<h3>Testing configuration parameters<a class="headerlink" href="#testing-configuration-parameters" title="Permalink to this headline">¶</a></h3>
<p>In order to ensure reproducibility of tests, all configuration items
are reset to their default values when the test runner starts up.</p>
<p>Sometimes you’ll want to test the behavior of code when a certain
configuration item is set to a particular value.  In that case, you
can use the <code class="xref py py-func docutils literal"><span class="pre">scikit-beam.config.ConfigItem.set_temp()</span></code> context manager to
temporarily set a configuration item to that value, test within that
context, and have it automatically return to its original value.</p>
<p>For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_pprint</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">...</span> <span class="k">import</span> <span class="n">conf</span>
    <span class="k">with</span> <span class="n">conf</span><span class="o">.</span><span class="n">set_temp</span><span class="p">(</span><span class="s1">&#39;max_lines&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
        <span class="c1"># ...</span>
</pre></div>
</div>
</div>
<div class="section" id="testing-with-unicode-literals">
<h3>Testing with Unicode literals<a class="headerlink" href="#testing-with-unicode-literals" title="Permalink to this headline">¶</a></h3>
<p>Python 2 can run code in two modes: by default, string literals are
8-bit <a class="reference external" href="https://docs.python.org/3.5/library/functions.html#bytes" title="(in Python v3.5)"><code class="xref py py-obj docutils literal"><span class="pre">bytes</span></code></a> objects.  However, when <code class="docutils literal"><span class="pre">from</span> <span class="pre">__future__</span> <span class="pre">import</span>
<span class="pre">unicode_literals</span></code> is used, string literals are <code class="xref py py-obj docutils literal"><span class="pre">unicode</span></code> objects.  In
order to ensure that scikit-beam supports user code written in both
styles, the testing framework has a special feature to run a module
containing tests in both modes.  Simply add the comment:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># TEST_UNICODE_LITERALS</span>
</pre></div>
</div>
<p>anywhere in the file, and all tests in that file will be tested twice:
once in the default mode where string literals are <a class="reference external" href="https://docs.python.org/3.5/library/functions.html#bytes" title="(in Python v3.5)"><code class="xref py py-obj docutils literal"><span class="pre">bytes</span></code></a>, and again
where string literals are <code class="xref py py-obj docutils literal"><span class="pre">unicode</span></code>.</p>
</div>
<div class="section" id="marking-blocks-of-code-to-exclude-from-coverage">
<h3>Marking blocks of code to exclude from coverage<a class="headerlink" href="#marking-blocks-of-code-to-exclude-from-coverage" title="Permalink to this headline">¶</a></h3>
<p>Blocks of code may be ignored by the coverage testing by adding a
comment containing the phrase <code class="docutils literal"><span class="pre">pragma:</span> <span class="pre">no</span> <span class="pre">cover</span></code> to the start of the
block:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">this_rarely_happens</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="n">this_call_is_ignored</span><span class="p">()</span>
</pre></div>
</div>
<p>Blocks of code that are intended to run only in Python 2.x or 3.x may
also be marked so that they will be ignored when appropriate by
<code class="docutils literal"><span class="pre">coverage.py</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># pragma: py3</span>
    <span class="n">do_it_the_python3_way</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: py2</span>
    <span class="n">do_it_the_python2_way</span><span class="p">()</span>
</pre></div>
</div>
<p>Using <code class="docutils literal"><span class="pre">six.PY3</span></code> and <code class="docutils literal"><span class="pre">six.PY2</span></code> will also automatically exclude
blocks from coverage, without requiring the pragma comment:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">six</span><span class="o">.</span><span class="n">PY3</span><span class="p">:</span>
    <span class="n">do_it_the_python3_way</span><span class="p">()</span>
<span class="k">elif</span> <span class="n">six</span><span class="o">.</span><span class="n">PY2</span><span class="p">:</span>
    <span class="n">do_it_the_python2_way</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="writing-doctests">
<span id="doctests"></span><h2>Writing doctests<a class="headerlink" href="#writing-doctests" title="Permalink to this headline">¶</a></h2>
<p>A doctest in Python is a special kind of test that is embedded in a
function, class, or module’s docstring, or in the narrative Sphinx
documentation, and is formatted to look like a Python interactive
session–that is, they show lines of Python code entered at a <code class="docutils literal"><span class="pre">&gt;&gt;&gt;</span></code>
prompt followed by the output that would be expected (if any) when
running that code in an interactive session.</p>
<p>The idea is to write usage examples in docstrings that users can enter
verbatim and check their output against the expected output to confirm that
they are using the interface properly.</p>
<p>Furthermore, Python includes a <a class="reference external" href="https://docs.python.org/3.5/library/doctest.html#module-doctest" title="(in Python v3.5)"><code class="xref py py-mod docutils literal"><span class="pre">doctest</span></code></a> module that can detect these
doctests and execute them as part of a project’s automated test suite.  This
way we can automatically ensure that all doctest-like examples in our
docstrings are correct.</p>
<p>The Scikit-beam test suite automatically detects and runs any doctests in
the Scikit-beam source code or documentation, or in affiliated packages
using the Scikit-beam test running framework. For example doctests and
detailed documentation on how to write them, see the full
<a class="reference external" href="https://docs.python.org/3.5/library/doctest.html#module-doctest" title="(in Python v3.5)"><code class="xref py py-mod docutils literal"><span class="pre">doctest</span></code></a> documentation.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since the narrative Sphinx documentation is not installed alongside
the scikit-beam source code, it can only be tested by running <code class="docutils literal"><span class="pre">python</span>
<span class="pre">setup.py</span> <span class="pre">test</span></code>, not by <code class="docutils literal"><span class="pre">import</span> <span class="pre">scikit-beam;</span> <span class="pre">scikit-beam.test()</span></code>.</p>
</div>
<div class="section" id="skipping-doctests">
<h3>Skipping doctests<a class="headerlink" href="#skipping-doctests" title="Permalink to this headline">¶</a></h3>
<p>Sometimes it is necessary to write examples that look like doctests but that
are not actually executable verbatim. An example may depend on some external
conditions being fulfilled, for example. In these cases there are a few ways to
skip a doctest:</p>
<ol class="arabic">
<li><p class="first">Next to the example add a comment like: <code class="docutils literal"><span class="pre">#</span> <span class="pre">doctest:</span> <span class="pre">+SKIP</span></code>.  For example:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>&gt;&gt;&gt; import os
&gt;&gt;&gt; os.listdir(&#39;.&#39;)  # doctest: +SKIP
</pre></div>
</div>
<p>In the above example we want to direct the user to run <code class="docutils literal"><span class="pre">os.listdir('.')</span></code>
but we don’t want that line to be executed as part of the doctest.</p>
<p>To skip tests that require fetching remote data, use the <code class="docutils literal"><span class="pre">REMOTE_DATA</span></code>
flag instead.  This way they can be turned on using the
<code class="docutils literal"><span class="pre">--remote-data</span></code> flag when running the tests:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>&gt;&gt;&gt; datafile = get_data_filename(&#39;hash/94935&#39;)  # doctest: +REMOTE_DATA
</pre></div>
</div>
</li>
<li><p class="first">Scikit-beam’s test framework adds support for a special <code class="docutils literal"><span class="pre">__doctest_skip__</span></code>
variable that can be placed at the module level of any module to list
functions, classes, and methods in that module whose doctests should not
be run.  That is, if it doesn’t make sense to run a function’s example
usage as a doctest, the entire function can be skipped in the doctest
collection phase.</p>
<p>The value of <code class="docutils literal"><span class="pre">__doctest_skip__</span></code> should be a list of wildcard patterns
for all functions/classes whose doctests should be skipped.  For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">__doctest_skip__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;myfunction&#39;</span><span class="p">,</span> <span class="s1">&#39;MyClass&#39;</span><span class="p">,</span> <span class="s1">&#39;MyClass.*&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>skips the doctests in a function called <code class="docutils literal"><span class="pre">myfunction</span></code>, the doctest for a
class called <code class="docutils literal"><span class="pre">MyClass</span></code>, and all <em>methods</em> of <code class="docutils literal"><span class="pre">MyClass</span></code>.</p>
<p>Module docstrings may contain doctests as well.  To skip the module-level
doctests include the string <code class="docutils literal"><span class="pre">'.'</span></code> in <code class="docutils literal"><span class="pre">__doctest_skip__</span></code>.</p>
<p>To skip all doctests in a module:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">__doctest_skip__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p class="first">In the Sphinx documentation, a doctest section can be skipped by
making it part of a <code class="docutils literal"><span class="pre">doctest-skip</span></code> directive:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">..</span> <span class="n">doctest</span><span class="o">-</span><span class="n">skip</span><span class="p">::</span>

    <span class="o">&gt;&gt;&gt;</span> <span class="c1"># This is a doctest that will appear in the documentation,</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="c1"># but will not be executed by the testing framework.</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span>  <span class="c1"># Divide by zero, ouch!</span>
</pre></div>
</div>
<p>It is also possible to skip all doctests below a certain line using
a <code class="docutils literal"><span class="pre">doctest-skip-all</span></code> comment.  Note the lack of <code class="docutils literal"><span class="pre">::</span></code> at the end
of the line here:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">..</span> <span class="n">doctest</span><span class="o">-</span><span class="n">skip</span><span class="o">-</span><span class="nb">all</span>

<span class="n">All</span> <span class="n">doctests</span> <span class="n">below</span> <span class="n">here</span> <span class="n">are</span> <span class="n">skipped</span><span class="o">...</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">__doctest_requires__</span></code> is a way to list dependencies for specific
doctests.  It should be a dictionary mapping wildcard patterns (in the same
format as <code class="docutils literal"><span class="pre">__doctest_skip__</span></code>) to a list of one or more modules that should
be <em>importable</em> in order for the tests to run.  For example, if some tests
require the scipy module to work they will be skipped unless <code class="docutils literal"><span class="pre">import</span>
<span class="pre">scipy</span></code> is possible.  It is also possible to use a tuple of wildcard
patterns as a key in this dict:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">__doctest_requires__</span> <span class="o">=</span> <span class="p">{(</span><span class="s1">&#39;func1&#39;</span><span class="p">,</span> <span class="s1">&#39;func2&#39;</span><span class="p">):</span> <span class="p">[</span><span class="s1">&#39;scipy&#39;</span><span class="p">]}</span>
</pre></div>
</div>
<p>Having this module-level variable will require <code class="docutils literal"><span class="pre">scipy</span></code> to be importable
in order to run the doctests for functions <code class="docutils literal"><span class="pre">func1</span></code> and <code class="docutils literal"><span class="pre">func2</span></code> in that
module.</p>
<p>In the Sphinx documentation, a doctest requirement can be notated with the
<code class="docutils literal"><span class="pre">doctest-requires</span></code> directive:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">..</span> <span class="n">doctest</span><span class="o">-</span><span class="n">requires</span><span class="p">::</span> <span class="n">scipy</span>

    <span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">scipy</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="n">scipy</span><span class="o">.</span><span class="n">hamming</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="skipping-output">
<h3>Skipping output<a class="headerlink" href="#skipping-output" title="Permalink to this headline">¶</a></h3>
<p>One of the important aspects of writing doctests is that the example output
can be accurately compared to the actual output produced when running the
test.</p>
<p>The doctest system compares the actual output to the example output verbatim
by default, but this not always feasible.  For example the example output may
contain the <code class="docutils literal"><span class="pre">__repr__</span></code> of an object which displays its id (which will change
on each run), or a test that expects an exception may output a traceback.</p>
<p>The simplest way to generalize the example output is to use the ellipses
<code class="docutils literal"><span class="pre">...</span></code>.  For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">ZeroDivisionError</span>: <span class="n">integer division or modulo by zero</span>
</pre></div>
</div>
<p>This doctest expects an exception with a traceback, but the text of the
traceback is skipped in the example output–only the first and last lines
of the output are checked.  See the <a class="reference external" href="https://docs.python.org/3.5/library/doctest.html#module-doctest" title="(in Python v3.5)"><code class="xref py py-mod docutils literal"><span class="pre">doctest</span></code></a> documentation for
more examples of skipping output.</p>
</div>
<div class="section" id="handling-float-output">
<h3>Handling float output<a class="headerlink" href="#handling-float-output" title="Permalink to this headline">¶</a></h3>
<p>Some doctests may produce output that contains string representations of
floating point values.  Floating point representations are often not exact and
contain roundoffs in their least significant digits.  Depending on the platform
the tests are being run on (different Python versions, different OS, etc.) the
exact number of digits shown can differ.  Because doctests work by comparing
strings this can cause such tests to fail.</p>
<p>To address this issue Scikit-beam’s test framework includes support for a
<code class="docutils literal"><span class="pre">FLOAT_CMP</span></code> flag that can be used with doctests.  For example:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>&gt;&gt;&gt; 1.0 / 3.0  # doctest: +FLOAT_CMP
0.333333333333333311
</pre></div>
</div>
<p>When this flag is used, the expected and actual outputs are both parsed to find
any floating point values in the strings.  Those are then converted to actual
Python <cite>float</cite> objects and compared numerically.  This means that small
differences in representation of roundoff digits will be ignored by the
doctest.  The values are otherwise compared exactly, so more significant
(albeit possibly small) differences will still be caught by these tests.</p>
</div>
<div class="section" id="continuous-integration">
<h3>Continuous integration<a class="headerlink" href="#continuous-integration" title="Permalink to this headline">¶</a></h3>
<p>Scikit-beam uses <a class="reference external" href="https://travis-ci.org/scikit-beam/scikit-beam">Travis</a> for continuous
integration (CI) on Linux and OSX setups, and <a class="reference external" href="https://ci.appveyor.com/project/Scikit-beam/scikit-beam">Appveyor</a> on Windows. These
continuously test the package for each commit and pull request that is pushed
to GitHub to notice when something breaks.</p>
<p>Dependencies can be customized for different packages using the appropriate
environmental variables in <code class="docutils literal"><span class="pre">.travis.yml</span></code> and <code class="docutils literal"><span class="pre">appveyor.yml</span></code>.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Testing Guidelines</a><ul>
<li><a class="reference internal" href="#testing-framework">Testing Framework</a></li>
<li><a class="reference internal" href="#running-tests">Running Tests</a><ul>
<li><a class="reference internal" href="#run-tests-py">run_tests.py</a></li>
<li><a class="reference internal" href="#id4">py.test</a></li>
<li><a class="reference internal" href="#scikit-beam-test">scikit-beam.test()</a></li>
<li><a class="reference internal" href="#tox">Tox</a></li>
<li><a class="reference internal" href="#test-running-options">Test-running options</a><ul>
<li><a class="reference internal" href="#running-parts-of-the-test-suite">Running parts of the test suite</a></li>
<li><a class="reference internal" href="#testing-for-open-files">Testing for open files</a></li>
<li><a class="reference internal" href="#test-coverage-reports">Test coverage reports</a></li>
<li><a class="reference internal" href="#running-tests-in-parallel">Running tests in parallel</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#writing-tests">Writing tests</a><ul>
<li><a class="reference internal" href="#simple-example">Simple example</a></li>
<li><a class="reference internal" href="#where-to-put-tests">Where to put tests</a><ul>
<li><a class="reference internal" href="#package-specific-tests">Package-specific tests</a></li>
<li><a class="reference internal" href="#interoperability-tests">Interoperability tests</a></li>
</ul>
</li>
<li><a class="reference internal" href="#regression-tests">Regression tests</a></li>
<li><a class="reference internal" href="#working-with-data-files">Working with data files</a><ul>
<li><a class="reference internal" href="#examples">Examples</a></li>
<li><a class="reference internal" href="#tests-that-use-the-file-cache">Tests that use the file cache</a></li>
</ul>
</li>
<li><a class="reference internal" href="#tests-that-create-files">Tests that create files</a></li>
<li><a class="reference internal" href="#setting-up-tearing-down-tests">Setting up/Tearing down tests</a><ul>
<li><a class="reference internal" href="#module-level-setup-teardown">Module-level setup/teardown</a></li>
<li><a class="reference internal" href="#class-level-setup-teardown">Class-level setup/teardown</a></li>
<li><a class="reference internal" href="#method-level-setup-teardown">Method-level setup/teardown</a></li>
<li><a class="reference internal" href="#function-level-setup-teardown">Function-level setup/teardown</a></li>
</ul>
</li>
<li><a class="reference internal" href="#parametrizing-tests">Parametrizing tests</a></li>
<li><a class="reference internal" href="#tests-requiring-optional-dependencies">Tests requiring optional dependencies</a></li>
<li><a class="reference internal" href="#using-py-test-helper-functions">Using py.test helper functions</a></li>
<li><a class="reference internal" href="#testing-warnings">Testing warnings</a></li>
<li><a class="reference internal" href="#testing-configuration-parameters">Testing configuration parameters</a></li>
<li><a class="reference internal" href="#testing-with-unicode-literals">Testing with Unicode literals</a></li>
<li><a class="reference internal" href="#marking-blocks-of-code-to-exclude-from-coverage">Marking blocks of code to exclude from coverage</a></li>
</ul>
</li>
<li><a class="reference internal" href="#writing-doctests">Writing doctests</a><ul>
<li><a class="reference internal" href="#skipping-doctests">Skipping doctests</a></li>
<li><a class="reference internal" href="#skipping-output">Skipping output</a></li>
<li><a class="reference internal" href="#handling-float-output">Handling float output</a></li>
<li><a class="reference internal" href="#continuous-integration">Continuous integration</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="docrules.html" title="previous chapter">Scikit-beam Docstring Rules</a></li>
      <li>Next: <a href="scripts.html" title="next chapter">Writing Command-Line Scripts</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/development/testguide.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2014-2015 Brookhaven National Lab.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../_sources/development/testguide.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>